Technical Implementation Plan: Fix Email Search Dynamic Imports & Remove Dead Code  
Current Problem
The 5Ducks application has 19 files (~2500 lines) of dead code in two folders that contain broken imports. These files reference a non-existent results-analysis folder. The working provider files (hunter.ts, apollo.ts, aeroleads.ts) have dynamic imports pointing to this broken code, which could cause runtime failures if triggered.
Phase 1: Replace Dynamic Imports with Direct API Implementations
1.1 Fix Hunter Provider (server/search/providers/hunter.ts)
Current problematic code (lines 56-60):
// Use enhanced orchestrator for better error handling and retries
const { EnhancedSearchOrchestrator } = await import('./email-discovery/enhanced-search-orchestrator');
const orchestrator = new EnhancedSearchOrchestrator();

const searchResult = await orchestrator.executeHunterSearch(contact, company, hunterApiKey);

Replace with direct Hunter API implementation:
// Direct Hunter API implementation
const searchResult = await searchHunterDirect(contact, company, hunterApiKey);

Add this function before the export (around line 10):
async function searchHunterDirect(contact: any, company: any, apiKey: string): Promise<any> {
try {
const axios = (await import('axios')).default;
const response = await axios.get('https://api.hunter.io/v2/email-finder', {
params: {
api_key: apiKey,
domain: company.website || company.name.toLowerCase().replace(/\s+/g, '') + '.com',
first_name: contact.name.split(' ')[0],
last_name: contact.name.split(' ').slice(1).join(' ')
},
timeout: 20000
});

if (response.data?.data?.email) {
return {
success: true,
contact: {
...contact,
email: response.data.data.email,
role: response.data.data.position || contact.role
},
metadata: {
confidence: response.data.data.score || 75,
searchDate: new Date().toISOString()
}
};
}

return {
success: false,
contact,
metadata: {
error: 'No email found',
searchDate: new Date().toISOString()
}
};
} catch (error) {
console.error('Hunter API error:', error);
return {
success: false,
contact,
metadata: {
error: error instanceof Error ? error.message : 'Hunter API failed',
searchDate: new Date().toISOString()
}
};
}
}

1.2 Fix Apollo Provider (server/search/providers/apollo.ts)
Current problematic code (lines 56-60):
// Use enhanced orchestrator for better error handling and retries
const { EnhancedSearchOrchestrator } = await import('./email-discovery/enhanced-search-orchestrator');
const orchestrator = new EnhancedSearchOrchestrator();

const searchResult = await orchestrator.executeApolloSearch(contact, company, apolloApiKey);

Replace with direct Apollo API implementation:
// Direct Apollo API implementation
const searchResult = await searchApolloDirect(contact, company, apolloApiKey);

Add this function before the export (around line 10):
async function searchApolloDirect(contact: any, company: any, apiKey: string): Promise<any> {
try {
const axios = (await import('axios')).default;
const response = await axios.post('https://api.apollo.io/v1/people/match', {
api_key: apiKey,
name: contact.name,
organization_name: company.name,
domain: company.website
}, {
timeout: 20000
});

if (response.data?.person?.email) {
return {
success: true,
contact: {
...contact,
email: response.data.person.email,
role: response.data.person.title || contact.role,
linkedinUrl: response.data.person.linkedin_url || contact.linkedinUrl,
phoneNumber: response.data.person.phone_numbers?.[0]?.sanitized_number || contact.phoneNumber
},
metadata: {
confidence: response.data.person.email_confidence || 75,
searchDate: new Date().toISOString()
}
};
}

return {
success: false,
contact,
metadata: {
error: 'No email found',
searchDate: new Date().toISOString()
}
};
} catch (error) {
console.error('Apollo API error:', error);
return {
success: false,
contact,
metadata: {
error: error instanceof Error ? error.message : 'Apollo API failed',
searchDate: new Date().toISOString()
}
};
}
}

1.3 Fix AeroLeads Provider (server/search/providers/aeroleads.ts)
Current problematic code (lines 57-68):
// Use the AeroLeads API to search for the email
const { searchAeroLeads } = await import('./email-discovery/aeroleads-search');
console.log('Initiating AeroLeads search for:', {
contactName: contact.name,
companyName: company.name
});

const result = await searchAeroLeads(
contact.name,
company.name,
aeroLeadsApiKey
);

Replace with direct AeroLeads API implementation:
// Direct AeroLeads API implementation
console.log('Initiating AeroLeads search for:', {
contactName: contact.name,
companyName: company.name
});

const result = await searchAeroLeadsDirect(
contact.name,
company.name,
aeroLeadsApiKey
);

Add this function before the export (around line 10):
async function searchAeroLeadsDirect(
name: string,
company: string,
apiKey: string
): Promise<{ email: string | null; confidence: number }> {
try {
const axios = (await import('axios')).default;
const nameParts = name.trim().split(/\s+/);
const firstName = nameParts[0];
const lastName = nameParts.slice(1).join(' ');

console.log(`Searching AeroLeads for: ${firstName} ${lastName} at ${company}`);

const response = await axios.get('https://aeroleads.com/api/get_email_details', {
params: {
api_key: apiKey,
first_name: firstName,
last_name: lastName,
company: company
},
timeout: 20000
});

console.log('AeroLeads API response:', response.data);

// Handle both response formats AeroLeads uses
if (response.data?.success && response.data?.data?.email) {
return {
email: response.data.data.email,
confidence: response.data.data.score || 75
};
}

if (response.data?.email) {
console.log(`Found email in direct response format: ${response.data.email}`);
return {
email: response.data.email,
confidence: 75
};
}

console.log('No email found in AeroLeads response');
return {
email: null,
confidence: 0
};
} catch (error) {
console.error('AeroLeads API error:', error);
if (axios.isAxiosError(error)) {
console.error('Response:', error.response?.data);
console.error('Status:', error.response?.status);
}
return {
email: null,
confidence: 0
};
}
}

1.4 Remove Unused Import from routes.ts
File: server/routes.ts Line 23: Delete this entire line:
import { emailEnrichmentService } from "./search/enrichment/email/email-enrichment/service";

Phase 2: Test the Fixes
2.1 Restart the application
npm run dev

2.2 Test each email search endpoint
Open the browser developer console and run:
// Test Hunter endpoint
fetch('/api/contacts/1/hunter', { method: 'POST' })
.then(r => r.json())
.then(console.log)

// Test Apollo endpoint
fetch('/api/contacts/1/apollo', { method: 'POST' })
.then(r => r.json())
.then(console.log)

// Test AeroLeads endpoint
fetch('/api/contacts/1/aeroleads', { method: 'POST' })
.then(r => r.json())
.then(console.log)

Each should return either:
* Authentication error (if not logged in) - this is OK
* API key not configured error - this is OK
* Contact not found error - this is OK
* NOT a module import error - if you see this, the fix didn't work
Phase 3: Remove Dead Code Folders
Only after Phase 1 and 2 are complete and tested:
3.1 Delete the email-discovery folder
rm -rf server/search/providers/email-discovery

3.2 Delete the enrichment/email folder
rm -rf server/search/enrichment

3.3 Verify application still works
* Restart the application
* Test the email search endpoints again
* Check for any console errors
Expected Results
After completion:
* ✅ Email search functionality works with direct API calls
* ✅ No dynamic imports to broken code
* ✅ ~2500 lines of dead code removed
* ✅ No runtime errors when clicking email search buttons
* ✅ Cleaner, more maintainable codebase
Files Modified Summary
1. server/search/providers/hunter.ts - Replace dynamic import with direct API
2. server/search/providers/apollo.ts - Replace dynamic import with direct API
3. server/search/providers/aeroleads.ts - Replace dynamic import with direct API
4. server/routes.ts - Remove unused emailEnrichmentService import
Folders to Delete (After Testing)
1. server/search/providers/email-discovery/ (15 files)
2. server/search/enrichment/ (4 files in email subfolder)
Important Notes
* The direct API implementations above match the expected response format used by the existing code
* Error handling preserves the current behavior
* Console logging is maintained for debugging
* The axios library is dynamically imported to match the existing pattern


